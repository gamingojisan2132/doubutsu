<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>どうぶつタワーバトル</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f7ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            touch-action: manipulation;
            overflow: hidden;
        }
        .game-title {
            font-size: 24px;
            margin: 10px 0;
            color: #3366cc;
        }
        .game-container {
            width: 100%;
            max-width: 500px;
            height: 80vh;
            background-color: #b3d9ff;
            position: relative;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .score-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 500px;
            padding: 10px;
            box-sizing: border-box;
        }
        .score-box {
            background-color: #ffffff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 45%;
            text-align: center;
        }
        .animal {
            position: absolute;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transform-origin: center bottom;
            transition: transform 0.1s;
        }
        .animal.active {
            opacity: 0.8;
            cursor: move;
        }
        .platform {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 20px;
            background-color: #663300;
        }
        .next-animal {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 60px;
            height: 60px;
            background-color: #ffffff;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .next-animal-image {
            max-width: 80%;
            max-height: 80%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 30px;
            display: none;
        }
        .restart-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
        }
        .control-panel {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 500px;
            padding: 10px;
            box-sizing: border-box;
        }
        .control-button {
            background-color: #3366cc;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            width: 45%;
        }
    </style>
</head>
<body>
    <div class="game-title">どうぶつタワーバトル</div>
    
    <div class="score-container">
        <div class="score-box">
            <div>最高高さ: <span id="max-height">0</span>m</div>
        </div>
        <div class="score-box">
            <div>積み上げた動物: <span id="animal-count">0</span>匹</div>
        </div>
    </div>
    
    <div class="game-container" id="game-container">
        <div class="platform"></div>
        <div class="next-animal">
            <div class="next-animal-image" id="next-animal-preview"></div>
        </div>
        <div class="game-over" id="game-over">
            <div>ゲームオーバー</div>
            <div>最高高さ: <span id="final-height">0</span>m</div>
            <div>積み上げた動物: <span id="final-count">0</span>匹</div>
            <button class="restart-button" id="restart-button">もう一度プレイ</button>
        </div>
    </div>
    
    <div class="control-panel">
        <button class="control-button" id="left-button">←</button>
        <button class="control-button" id="right-button">→</button>
    </div>

    <script>
        // 動物の設定
        const animals = [
            { name: 'ねこ', width: 60, height: 40, image: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 40"><ellipse cx="30" cy="25" rx="25" ry="15" fill="%23f9c17c"/><circle cx="20" cy="18" r="5" fill="%23333"/><circle cx="40" cy="18" r="5" fill="%23333"/><path d="M15 10 L5 0 M45 10 L55 0" stroke="%23f9c17c" stroke-width="2"/><path d="M25 30 Q30 35 35 30" stroke="%23333" stroke-width="1" fill="none"/></svg>', weight: 1, stability: 0.8 },
            { name: 'いぬ', width: 70, height: 50, image: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 70 50"><ellipse cx="35" cy="30" rx="30" ry="20" fill="%23a5774f"/><circle cx="25" cy="20" r="5" fill="%23333"/><circle cx="45" cy="20" r="5" fill="%23333"/><path d="M20 10 L10 0 M50 10 L60 0" stroke="%23a5774f" stroke-width="3"/><path d="M30 35 Q35 40 40 35" stroke="%23333" stroke-width="1" fill="none"/></svg>', weight: 1.5, stability: 0.7 },
            { name: 'パンダ', width: 65, height: 60, image: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 65 60"><ellipse cx="32.5" cy="35" rx="25" ry="25" fill="%23ffffff"/><circle cx="22" cy="25" r="8" fill="%23333"/><circle cx="43" cy="25" r="8" fill="%23333"/><ellipse cx="32.5" cy="40" rx="8" ry="5" fill="%23333"/><circle cx="22" cy="25" r="5" fill="%23ffffff"/><circle cx="43" cy="25" r="5" fill="%23ffffff"/><path d="M15 15 L5 5 M50 15 L60 5" stroke="%23333" stroke-width="3"/></svg>', weight: 2, stability: 0.9 },
            { name: 'うさぎ', width: 50, height: 70, image: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 70"><ellipse cx="25" cy="45" rx="20" ry="25" fill="%23f4f4f4"/><circle cx="20" cy="35" r="3" fill="%23333"/><circle cx="30" cy="35" r="3" fill="%23333"/><ellipse cx="25" cy="40" rx="5" ry="3" fill="%23ff9e9e"/><path d="M15 20 L10 0 M35 20 L40 0" stroke="%23f4f4f4" stroke-width="5"/></svg>', weight: 0.8, stability: 0.6 },
            { name: 'ぞう', width: 80, height: 60, image: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 60"><ellipse cx="40" cy="35" rx="35" ry="25" fill="%23aaa9ad"/><circle cx="30" cy="25" r="5" fill="%23333"/><circle cx="50" cy="25" r="5" fill="%23333"/><path d="M40 35 Q50 55 60 50" stroke="%23aaa9ad" stroke-width="10" fill="none"/><path d="M15 25 Q5 15 10 5" stroke="%23aaa9ad" stroke-width="10" fill="none"/><path d="M65 25 Q75 15 70 5" stroke="%23aaa9ad" stroke-width="10" fill="none"/></svg>', weight: 3, stability: 0.75 },
            { name: 'きりん', width: 50, height: 90, image: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 90"><path d="M25 80 L25 30" stroke="%23f4c430" stroke-width="10"/><ellipse cx="25" cy="20" rx="15" ry="10" fill="%23f4c430"/><circle cx="20" cy="15" r="3" fill="%23333"/><circle cx="30" cy="15" r="3" fill="%23333"/><path d="M20 5 L15 0 M30 5 L35 0" stroke="%23f4c430" stroke-width="3"/><path d="M20 80 L15 90 M30 80 L35 90" stroke="%23f4c430" stroke-width="5"/><path d="M20 70 L10 75 M30 70 L40 75" stroke="%23f4c430" stroke-width="5"/></svg>', weight: 1.2, stability: 0.5 }
        ];

        // ゲーム変数
        let activeAnimal = null;
        let nextAnimal = null;
        let animalCount = 0;
        let maxHeight = 0;
        let gameOver = false;
        let placedAnimals = [];

        const gameContainer = document.getElementById('game-container');
        const gameOverScreen = document.getElementById('game-over');
        const restartButton = document.getElementById('restart-button');
        const maxHeightDisplay = document.getElementById('max-height');
        const animalCountDisplay = document.getElementById('animal-count');
        const finalHeightDisplay = document.getElementById('final-height');
        const finalCountDisplay = document.getElementById('final-count');
        const nextAnimalPreview = document.getElementById('next-animal-preview');
        const leftButton = document.getElementById('left-button');
        const rightButton = document.getElementById('right-button');

        // 画面サイズを取得
        const gameWidth = gameContainer.clientWidth;
        const gameHeight = gameContainer.clientHeight;

        // ゲーム初期化
        function initGame() {
            // 既存の動物をクリア
            gameContainer.querySelectorAll('.animal').forEach(el => el.remove());
            
            // ゲーム変数のリセット
            activeAnimal = null;
            animalCount = 0;
            maxHeight = 0;
            gameOver = false;
            placedAnimals = [];
            
            // 表示のリセット
            updateScore();
            gameOverScreen.style.display = 'none';
            
            // 最初の動物を選択
            spawnNextAnimal();
            spawnNewAnimal();
        }

        // 次の動物を選択
        function spawnNextAnimal() {
            nextAnimal = animals[Math.floor(Math.random() * animals.length)];
            
            // プレビューを更新
            nextAnimalPreview.style.width = `${nextAnimal.width * 0.8}px`;
            nextAnimalPreview.style.height = `${nextAnimal.height * 0.8}px`;
            nextAnimalPreview.style.backgroundImage = `url('${nextAnimal.image}')`;
        }

        // 新しい動物を出現させる
        function spawnNewAnimal() {
            if (gameOver) return;
            
            const animal = nextAnimal;
            spawnNextAnimal();
            
            // 動物要素の作成
            const animalEl = document.createElement('div');
            animalEl.className = 'animal active';
            animalEl.style.width = `${animal.width}px`;
            animalEl.style.height = `${animal.height}px`;
            animalEl.style.backgroundImage = `url('${animal.image}')`;
            animalEl.style.left = `${(gameWidth - animal.width) / 2}px`;
            animalEl.style.top = `${50}px`;
            
            // 動物のデータを保存
            animalEl.dataset.name = animal.name;
            animalEl.dataset.weight = animal.weight;
            animalEl.dataset.stability = animal.stability;
            
            gameContainer.appendChild(animalEl);
            activeAnimal = animalEl;
        }

        // 動物を配置する
        function placeAnimal() {
            if (!activeAnimal || gameOver) return;
            
            activeAnimal.classList.remove('active');
            
            // 衝突判定
            const animalRect = activeAnimal.getBoundingClientRect();
            const containerRect = gameContainer.getBoundingClientRect();
            
            // 動物の位置情報を取得
            const left = parseFloat(activeAnimal.style.left);
            const top = parseFloat(activeAnimal.style.top);
            const width = parseFloat(activeAnimal.style.width);
            const height = parseFloat(activeAnimal.style.height);
            
            // 配置した動物の情報を保存
            placedAnimals.push({
                element: activeAnimal,
                left: left,
                top: top,
                width: width,
                height: height,
                stability: parseFloat(activeAnimal.dataset.stability)
            });
            
            // 高さを更新
            const animalTop = containerRect.height - (animalRect.top - containerRect.top + animalRect.height);
            if (animalTop > maxHeight) {
                maxHeight = animalTop;
            }
            
            // カウントを更新
            animalCount++;
            updateScore();
            
            // タワーの安定性をチェック
            checkTowerStability();
            
            // 画面外に出たらゲームオーバー
            if (animalRect.top < containerRect.top) {
                endGame();
                return;
            }
            
            // 新しい動物を出現
            spawnNewAnimal();
        }

        // タワーの安定性をチェック
        function checkTowerStability() {
            if (placedAnimals.length < 2) return;
            
            // 最後に配置した動物
            const lastAnimal = placedAnimals[placedAnimals.length - 1];
            
            // 下にある動物を探す
            for (let i = placedAnimals.length - 2; i >= 0; i--) {
                const lowerAnimal = placedAnimals[i];
                
                // 動物同士が重なっているか
                if (overlap(lastAnimal, lowerAnimal)) {
                    // 安定性をチェック
                    const overlapWidth = Math.min(
                        lastAnimal.left + lastAnimal.width, 
                        lowerAnimal.left + lowerAnimal.width
                    ) - Math.max(lastAnimal.left, lowerAnimal.left);
                    
                    const overlapRatio = overlapWidth / lastAnimal.width;
                    
                    // 重なりが少なすぎる場合、タワーが崩れる確率が上がる
                    if (overlapRatio < 0.3) {
                        const stabilityCheck = Math.random();
                        if (stabilityCheck > lastAnimal.stability * overlapRatio * 3) {
                            // タワーが崩れる
                            animateTowerCollapse();
                            return;
                        }
                    }
                    
                    // 少なくとも1つの動物と十分に重なっていれば安定
                    return;
                }
            }
            
            // 何も支えていなければ崩れる
            animateTowerCollapse();
        }

        // 動物同士の重なりをチェック
        function overlap(a, b) {
            return !(
                a.left + a.width < b.left ||
                a.left > b.left + b.width ||
                a.top + a.height < b.top ||
                a.top > b.top + b.height
            );
        }

        // タワーが崩れるアニメーション
        function animateTowerCollapse() {
            placedAnimals.forEach(animal => {
                const el = animal.element;
                const rotation = (Math.random() - 0.5) * 90;
                const fallSpeed = 2 + Math.random() * 3;
                
                el.style.transition = 'transform 0.5s ease-in, top 0.5s ease-in';
                el.style.transform = `rotate(${rotation}deg)`;
                
                setTimeout(() => {
                    el.style.top = `${gameHeight}px`;
                }, 100);
            });
            
            setTimeout(endGame, 800);
        }

        // ゲームオーバー処理
        function endGame() {
            gameOver = true;
            
            finalHeightDisplay.textContent = Math.floor(maxHeight);
            finalCountDisplay.textContent = animalCount;
            
            gameOverScreen.style.display = 'flex';
        }

        // スコア表示を更新
        function updateScore() {
            maxHeightDisplay.textContent = Math.floor(maxHeight);
            animalCountDisplay.textContent = animalCount;
        }

        // 動物の移動
        function moveAnimal(direction) {
            if (!activeAnimal || gameOver) return;
            
            const step = 10;
            const currentLeft = parseFloat(activeAnimal.style.left);
            const width = parseFloat(activeAnimal.style.width);
            
            let newLeft = currentLeft + (direction === 'left' ? -step : step);
            
            // 画面の境界チェック
            if (newLeft < 0) {
                newLeft = 0;
            } else if (newLeft + width > gameWidth) {
                newLeft = gameWidth - width;
            }
            
            activeAnimal.style.left = `${newLeft}px`;
        }

        // イベントリスナー
        leftButton.addEventListener('mousedown', () => {
            const interval = setInterval(() => moveAnimal('left'), 50);
            document.addEventListener('mouseup', () => clearInterval(interval), { once: true });
        });

        rightButton.addEventListener('mousedown', () => {
            const interval = setInterval(() => moveAnimal('right'), 50);
            document.addEventListener('mouseup', () => clearInterval(interval), { once: true });
        });

        leftButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const interval = setInterval(() => moveAnimal('left'), 50);
            document.addEventListener('touchend', () => clearInterval(interval), { once: true });
        });

        rightButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const interval = setInterval(() => moveAnimal('right'), 50);
            document.addEventListener('touchend', () => clearInterval(interval), { once: true });
        });

        // タップでドロップ
        gameContainer.addEventListener('click', placeAnimal);
        gameContainer.addEventListener('touchend', (e) => {
            if (e.target === gameContainer || e.target.classList.contains('active')) {
                placeAnimal();
            }
        });

        restartButton.addEventListener('click', initGame);

        // キーボード操作
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                moveAnimal('left');
            } else if (e.key === 'ArrowRight') {
                moveAnimal('right');
            } else if (e.key === ' ' || e.key === 'Enter') {
                placeAnimal();
            }
        });

        // 自動落下機能（難易度調整用）
        let autoDropInterval = null;
        
        function startAutoDropTimer() {
            if (autoDropInterval) clearInterval(autoDropInterval);
            autoDropInterval = setInterval(() => {
                if (activeAnimal && !gameOver) {
                    // 少しずつ下に移動
                    const currentTop = parseFloat(activeAnimal.style.top);
                    activeAnimal.style.top = `${currentTop + 2}px`;
                    
                    // 一定の高さを超えたら配置
                    if (currentTop > gameHeight * 0.7) {
                        placeAnimal();
                    }
                }
            }, 100);
        }

        // ゲーム開始
        window.addEventListener('load', () => {
            initGame();
            startAutoDropTimer();
        });

        // ウィンドウリサイズ時の処理
        window.addEventListener('resize', () => {
            location.reload();
        });
    </script>
</body>
</html>
